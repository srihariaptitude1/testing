name: GnuPG Bundle (Fast & Stable)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  bundle:
    runs-on: windows-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Cache GnuPG
        id: cache-gnupg
        uses: actions/cache@v4
        with:
          path: resources/bin/gnupg
          key: gnupg-2.4.8-fast-v2

      - name: Extract GnuPG (No Installer Run)
        if: steps.cache-gnupg.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          $tempDir = "C:\temp_gpg"
          $targetDir = Join-Path (Get-Location) "resources/bin/gnupg"
          $installer = "$env:TEMP\gnupg.exe"
          
          # 1. Faster download with curl
          curl.exe -L "https://gnupg.org/ftp/gcrypt/binary/gnupg-w32-2.4.8_20250514.exe" -o $installer
          
          # 2. Extract files using 7-Zip (INSTANT - no hanging)
          # We extract the $OUTDIR which contains the bin/lib/share structure
          & "C:\Program Files\7-Zip\7z.exe" x $installer "-o$tempDir"
          
          # 3. Move only the actual content folder to your resources
          if (!(Test-Path "resources/bin")) { New-Item -ItemType Directory -Path "resources/bin" -Force }
          Move-Item -Path "$tempDir\$_OUTDIR\*" -Destination $targetDir -Force
          
          Remove-Item $installer, $tempDir -Recurse

      - name: Verify Bundle
        run: |
          ./resources/bin/gnupg/bin/gpg.exe --version
      - name: Upload GnuPG Bundle
        uses: actions/upload-artifact@v4
        with:
          name: gnupg-binaries  # This is the name you will see on GitHub
          path: resources/bin/gnupg/
          retention-days: 5      # How long GitHub keeps the file (default is 90)
