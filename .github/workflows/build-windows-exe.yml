name: Fast GnuPG Bundle

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # STEP 1: Cache GnuPG files to skip download in future runs
      - name: Cache GnuPG
        id: cache-gnupg
        uses: actions/cache@v4
        with:
          path: resources/bin/gnupg
          key: gnupg-2.4.8-v1

      # STEP 2: Only download if cache was NOT found
      - name: Download and Bundle GnuPG
        if: steps.cache-gnupg.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          $targetDir = Join-Path (Get-Location) "resources/bin/gnupg"
          $installer = "$env:TEMP\gnupg_installer.exe"
          
          if (!(Test-Path "resources/bin")) { New-Item -ItemType Directory -Path "resources/bin" -Force }

          # Using curl.exe is much faster than Invoke-WebRequest
          $url = "https://gnupg.org/ftp/gcrypt/binary/gnupg-w32-2.4.8_20250514.exe"
          Write-Host "Downloading via curl..."
          curl.exe -L $url -o $installer

          Write-Host "Extracting to $targetDir..."
          Start-Process -FilePath $installer -ArgumentList "/S", "/D=$targetDir" -Wait
          
          Remove-Item $installer

      # STEP 3: Always verify (Works whether from Cache or Download)
      - name: Verify GnuPG
        shell: pwsh
        run: |
          $gpg = "resources/bin/gnupg/bin/gpg.exe"
          if (Test-Path $gpg) {
            Write-Host "GnuPG ready."
            & $gpg --version
          } else {
            throw "GnuPG missing!"
          }
