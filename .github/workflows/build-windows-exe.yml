name: Bundle GnuPG

on:
  # push:
  #   branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install GnuPG
        run: |
          # Use Chocolatey to install the official Windows binary
          choco install gnupg --yes
          
          # Add to PATH for the current session
          echo "C:\Program Files (x86)\gnupg\bin" >> $GITHUB_PATH

      - name: Run Prep Script
        shell: pwsh
        run: |
          # The script will now find GnuPG at C:\Program Files (x86)\gnupg
          ./scripts/prep-gpg.ps1 -Force

      - name: Verify Bundle
        shell: pwsh
        run: |
          if (Test-Path "resources/bin/gnupg/bin/gpg.exe") {
            Write-Host "GnuPG successfully bundled!"
          } else {
            throw "GnuPG bundling failed."
          }

      # Optional: Upload the bundled resources as an artifact
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: bundled-gpg
          path: resources/bin/gnupg/
