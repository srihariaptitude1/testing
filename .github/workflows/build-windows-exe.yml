name: Bundle GnuPG

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download and Bundle GnuPG
        shell: pwsh
        run: |
          # 1. Setup target paths
          $targetDir = Join-Path (Get-Location) "resources/bin/gnupg"
          $installer = "$env:TEMP\gnupg_installer.exe"
          
          # Ensure directories exist
          if (!(Test-Path "resources/bin")) { New-Item -ItemType Directory -Path "resources/bin" -Force }

          # 2. Download official GnuPG (matching your version 2.4.8)
          $url = "https://gnupg.org/ftp/gcrypt/binary/gnupg-w32-2.4.8_20250514.exe"
          Write-Host "Downloading from $url..."
          Invoke-WebRequest -Uri $url -OutFile $installer

          # 3. Silent Extraction to resources folder
          # /S = Silent mode
          # /D = Destination directory
          Write-Host "Extracting to $targetDir..."
          Start-Process -FilePath $installer -ArgumentList "/S", "/D=$targetDir" -Wait

          # 4. Verification
          if (Test-Path "$targetDir\bin\gpg.exe") {
            Write-Host "Successfully bundled GnuPG executables."
            & "$targetDir\bin\gpg.exe" --version
          } else {
            throw "GnuPG extraction failed!"
          }

      - name: Pack Application
        run: |
          echo "Proceeding to pack application. GnuPG files are ready in resources/bin/gnupg"
          # Add your Electron or Python packing command here
