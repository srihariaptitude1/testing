name: Fast GnuPG Bundle

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache GnuPG
        id: cache-gnupg
        uses: actions/cache@v4
        with:
          path: resources/bin/gnupg
          key: gnupg-2.4.8-zip-v1

      - name: Download and Unzip GnuPG
        if: steps.cache-gnupg.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          # 1. Setup paths
          $binDir = "resources/bin"
          if (!(Test-Path $binDir)) { New-Item -ItemType Directory -Path $binDir -Force }
          $zipFile = "$env:TEMP\gnupg.zip"
          
          # 2. Download the PORTABLE version (much smaller and faster)
          # This is the "w32cli" version which contains the core .exe files you need.
          $url = "https://gnupg.org/ftp/gcrypt/binary/gnupg-w32cli-2.2.42.zip"
          Write-Host "Downloading GnuPG Zip via curl..."
          curl.exe -L $url -o $zipFile

          # 3. Fast Unzip (No installer lag)
          Write-Host "Unzipping to resources/bin/gnupg..."
          Expand-Archive -Path $zipFile -DestinationPath "resources/bin/gnupg" -Force
          
          Remove-Item $zipFile

      - name: Verify GnuPG
        shell: pwsh
        run: |
          # Note: The zip structure puts gpg.exe in the 'bin' folder of the zip
          $gpg = "resources/bin/gnupg/bin/gpg.exe"
          if (Test-Path $gpg) {
            Write-Host "GnuPG Ready!"
            & $gpg --version
          } else {
            throw "GnuPG missing at $gpg"
          }
