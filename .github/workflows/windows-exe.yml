name: Build Windows EXE (auto-bundle git + gnupg + python into resources)

on:
  push:
    branches: [ main ]
    tags: [ "v*" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-win:
    runs-on: windows-latest

    env:
      # Pin versions (reproducible builds)
      GITFORWINDOWS_TAG: "v2.53.0.windows.1"
      PORTABLEGIT_EXE: "PortableGit-2.53.0-64-bit.7z.exe"
      GNUPG_EXE: "gnupg-w32-2.4.8_20250514.exe"
      PY_EMBED_VER: "3.13.12"
      PY_EMBED_ZIP: "python-3.13.12-embeddable-amd64.zip"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm

      - name: Setup Python (build-time only)
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: pip

      - name: Cache bundled tools
        uses: actions/cache@v4
        with:
          path: |
            resources/bin/git
            resources/bin/gnupg
            resources/python
          key: tools-win-${{ env.GITFORWINDOWS_TAG }}-${{ env.GNUPG_EXE }}-py${{ env.PY_EMBED_VER }}-v2

      - name: Prepare resources folders
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path resources/bin | Out-Null
          New-Item -ItemType Directory -Force -Path resources/python | Out-Null

      # ----------------------------
      # Bundle Git -> resources/bin/git (PortableGit)
      # ----------------------------
      - name: Bundle Git (PortableGit)
        shell: pwsh
        run: |
          $target = "resources/bin/git"
          
          # Check for git in multiple possible paths
          if (Test-Path "$target/cmd/git.exe" -or (Test-Path "$target/bin/git.exe") -or (Test-Path "$target/mingw64/bin/git.exe")) {
            Write-Host "Git already present."
            exit 0
          }

          $url = "https://github.com/git-for-windows/git/releases/download/$env:GITFORWINDOWS_TAG/$env:PORTABLEGIT_EXE"
          $installer = Join-Path $env:TEMP $env:PORTABLEGIT_EXE
          $tmp = Join-Path $env:TEMP ("portablegit_" + [Guid]::NewGuid().ToString("N"))

          Write-Host "Downloading Git..."
          curl.exe -L $url -o $installer
          if (-not (Test-Path $installer)) {
            throw "Download failed for $url"
          }

          Write-Host "Extracting PortableGit..."
          New-Item -ItemType Directory -Force -Path $tmp | Out-Null
          & "C:\Program Files\7-Zip\7z.exe" x $installer "-o$tmp" | Out-Null

          Write-Host "Checking extracted files..."
          Get-ChildItem -Path $tmp -Recurse | Select-Object FullName

          function HasGit($p) {
            return (Test-Path (Join-Path $p "cmd\git.exe")) -or
                   (Test-Path (Join-Path $p "bin\git.exe")) -or
                   (Test-Path (Join-Path $p "mingw64\bin\git.exe"))
          }

          $gitRoot = $null

          # 1) Check tmp itself first (common case)
          if (HasGit $tmp) {
            $gitRoot = $tmp
          } else {
            # 2) Otherwise search subdirectories for a folder that contains git
            $gitRoot = Get-ChildItem -Path $tmp -Directory -Recurse |
              Where-Object { HasGit $_.FullName } |
              Select-Object -First 1 |
              ForEach-Object { $_.FullName }
          }

          if (-not $gitRoot) {
            Write-Host "PortableGit extraction listing (first 200 items):"
            Get-ChildItem -Path $tmp -Recurse -File | Select-Object -First 200 FullName
            throw "PortableGit extraction failed: git.exe not found in cmd/bin/mingw64/bin."
          }

          Remove-Item -Recurse -Force $target -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Force -Path $target | Out-Null
          Copy-Item -Path (Join-Path $gitRoot "*") -Destination $target -Recurse -Force

          Remove-Item -Recurse -Force $tmp
          Remove-Item -Force $installer

      - name: Verify Git bundle
        shell: pwsh
        run: |
          if (Test-Path "./resources/bin/git/cmd/git.exe") {
            ./resources/bin/git/cmd/git.exe --version
          } elseif (Test-Path "./resources/bin/git/bin/git.exe") {
            ./resources/bin/git/bin/git.exe --version
          } elseif (Test-Path "./resources/bin/git/mingw64/bin/git.exe") {
            ./resources/bin/git/mingw64/bin/git.exe --version
          } else {
            throw "No git.exe found after bundling."
          }

      # ----------------------------
      # Bundle GnuPG -> resources/bin/gnupg
      # ----------------------------
      - name: Bundle GnuPG
        shell: pwsh
        run: |
          $targetDir = "resources/bin/gnupg"
          if (Test-Path "$targetDir/bin/gpg.exe") { Write-Host "GnuPG already present."; exit 0 }

          $installer = Join-Path $env:TEMP $env:GNUPG_EXE
          $tmp = "C:\temp_gpg_$([Guid]::NewGuid().ToString('N'))"

          curl.exe -L "https://gnupg.org/ftp/gcrypt/binary/$env:GNUPG_EXE" -o $installer
          & "C:\Program Files\7-Zip\7z.exe" x $installer "-o$tmp" | Out-Null

          $gpgRoot = $null
          if (Test-Path (Join-Path $tmp "bin\gpg.exe")) {
            $gpgRoot = $tmp
          } else {
            $gpgRoot = Get-ChildItem -Path $tmp -Directory -Recurse |
              Where-Object { Test-Path (Join-Path $_.FullName "bin\gpg.exe") } |
              Select-Object -First 1 |
              ForEach-Object { $_.FullName }
          }

          if (-not $gpgRoot) { throw "GnuPG extraction failed: bin\gpg.exe not found." }

          Remove-Item -Recurse -Force $targetDir -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Force -Path $targetDir | Out-Null
          Copy-Item -Path (Join-Path $gpgRoot "*") -Destination $targetDir -Recurse -Force

          Remove-Item -Recurse -Force $tmp
          Remove-Item -Force $installer

      - name: Verify GnuPG bundle
        shell: pwsh
        run: |
          ./resources/bin/gnupg/bin/gpg.exe --version
          ./resources/bin/gnupg/bin/gpgconf.exe --version

      # ----------------------------
      # Bundle Python embeddable -> resources/python
      # ----------------------------
      - name: Bundle Python embeddable
        shell: pwsh
        run: |
          $target = "resources/python"
          if (Test-Path "$target/python.exe") { Write-Host "Python already present."; exit 0 }

          $zipName = $env:PY_EMBED_ZIP
          $url = "https://www.python.org/ftp/python/$env:PY_EMBED_VER/$zipName"
          $zip = Join-Path $env:TEMP $zipName

          curl.exe -L $url -o $zip
          Expand-Archive -Path $zip -DestinationPath $target -Force
          Remove-Item -Force $zip

          if (-not (Test-Path "$target/python.exe")) { throw "python.exe missing after extraction." }

      - name: Verify Python bundle
        shell: pwsh
        run: |
          ./resources/python/python.exe -V

      # ----------------------------
      # Build backend EXE (PyInstaller)
      # ----------------------------
      - name: Install Python deps (build-time)
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build backend EXE
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path backend-dist/wizard-backend | Out-Null
          pyinstaller wizard-backend.spec --noconfirm --clean --distpath backend-dist/wizard-backend --workpath build-backend
          if (-not (Test-Path "backend-dist/wizard-backend/wizard-backend.exe")) {
            throw "wizard-backend.exe not found in backend-dist/wizard-backend"
          }

      # ----------------------------
      # Build Electron Windows installer / EXE
      # ----------------------------
      - name: Install Node deps
        shell: pwsh
        run: |
          npm ci --no-audit --no-fund

      - name: Build Windows artifacts (NSIS)
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          npx electron-builder --win nsis

      - name: Upload dist artifact (always)
        uses: actions/upload-artifact@v4
        with:
          name: windows-dist
          path: dist/**
          retention-days: 7

      - name: Publish to GitHub Release (tag only)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: dist/**
